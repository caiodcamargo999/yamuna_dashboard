// Server Component

import { Header } from "@/components/layout/Header";
import { Suspense } from "react";
import { getMetaTopCreatives } from "@/lib/services/meta";
import { MetaAdsClient } from "./MetaAdsClient";

export default async function MetaAdsPage({ searchParams }: { searchParams: Promise<{ start?: string; end?: string }> }) {
    const params = await searchParams;
    const startDate = params.start || "30daysAgo";
    const endDate = params.end || "today";

    const formatMetaDate = (str: string) => {
        const d = new Date();
        if (str === "today") return d.toISOString().split('T')[0];
        if (str === "30daysAgo") {
            d.setDate(d.getDate() - 30);
            return d.toISOString().split('T')[0];
        }
        return str;
    };

    const s = formatMetaDate(startDate);
    const e = formatMetaDate(endDate);

    const creativesResult: any = await getMetaTopCreatives(s, e);

    // Check if result is an error object
    const error = !Array.isArray(creativesResult) ? creativesResult.error : null;
    const creatives = Array.isArray(creativesResult) ? creativesResult : [];

    return (
        <>
            <Suspense fallback={<div className="h-16 bg-slate-900 border-b border-slate-800" />}>
                <Header title="Meta Ads - Criativos" />
            </Suspense>
            <main className="p-6 space-y-6 overflow-y-auto w-full">
                {error && (
                    <div className="bg-red-500/10 border border-red-500/50 rounded-lg p-4 mb-4">
                        <div className="flex items-center gap-2 text-red-500 font-bold mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                            </svg>
                            Erro na Conex√£o com Meta Ads
                        </div>
                        <p className="text-red-400 text-sm font-mono">{error}</p>
                        <p className="text-red-400/70 text-xs mt-2">Verifique seu Token de Acesso em .env.local</p>
                    </div>
                )}

                <MetaAdsClient creatives={creatives} startDate={startDate} endDate={endDate} />
            </main>
        </>
    );
}
